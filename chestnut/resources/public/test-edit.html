<!doctype html>

<title>CodeMirror: Closebrackets Demo</title>
<meta charset="utf-8"/>
<link rel=stylesheet href="../doc/docs.css">

<link rel="stylesheet" href="/codemirror-5.1/lib/codemirror.css">
<script src="/codemirror-5.1/lib/codemirror.js"></script>
<script src="/codemirror-5.1/addon/edit/closebrackets.js"></script>
<script src="/codemirror-5.1/mode/clojure/clojure.js"></script>
<script src="/codemirror-5.1/addon/display/placeholder.js"></script>
<script src="/codemirror-5.1/addon/runmode/runmode.js"></script>

<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>


<style type="text/css">
      .CodeMirror {border-top: 1px solid #888; border-bottom: 1px solid #888;}

      .EvalResult {border-left: 2px solid #000;}
    </style>




<article>
<h2>Closebrackets Demo</h2>

    <div style="width:50%">
<form><textarea id="code" name="code" placeholder="Code goes here...">

    (+ 1 2)
    (Azeaze)

    </textarea>

    </div>

    </form>

    <script type="text/javascript">


        var allCoderes = []

        var editor = CodeMirror.fromTextArea(document.getElementById("code"),
                                             {autoCloseBrackets: true,
                                              styleActiveLine: true,
                                              lineNumbers: true,
                                              lineWrapping: true
                                             });


        editor.on("changes", function(target, changes) {


            allCoderes = allCoderes.map(function (codePiece) {
               if(codePiece.markedText.find()) {

                   var textLine = codePiece.markedText.find().to.line;

                   var widgetLine = codePiece.lineWidget.line.lineNo();
                   if(textLine != widgetLine) {
                    var oldWidget = codePiece.lineWidget;
                    codePiece.lineWidget = editor.addLineWidget(textLine,codePiece.lineWidget.node);
                    oldWidget.clear();
                   }
                   return codePiece;

               } else {
                   if(codePiece.lineWidget) {
                       codePiece.lineWidget.clear();
                   }
                   return undefined;

               }
            });

            allCoderes = allCoderes.filter(function(x) {return x;});

      });


        var createYoloElement = function (html) {
            var outer = document.createElement('div');
            var inner = document.createElement('div');
            outer.appendChild(inner);
            inner.className = "EvalResult";

            var appendToInner = function(s) {
                inner.innerHTML += s;
            };

            html.split("\n").forEach(function (s) {
                var dumb = document.createElement('div');
                CodeMirror.runMode(s, "text/x-clojure", dumb);
                inner.appendChild(dumb);
                appendToInner("<br>");
            });

            inner.removeChild(inner.lastChild);

            return outer;
        }

        var comparePos = function (a,b) {
          if(a.line == b.line) {
            return a.ch - b.ch
          } else {
            return a.line - b.line
          }
        }

        var findIntersectedMarks = function (editor, from, to) {
          return editor.getAllMarks().filter(function (m)Â {
            var f = m.find();
            return (comparePos(f.to, from) > 0 && comparePos(to, f.from) > 0);
          });
        };


        var clearEval = function (from, to) {

          console.log([from, to]);
          findIntersectedMarks(editor, CodeMirror.Pos(from.line, from.pos),
            CodeMirror.Pos(to.line, to.pos)).forEach(function(m) {
              m.clear();
              m.coderes.lineWidget.clear();
            }
            );
        };

        var createEvalResult = function (cm, evalres) {
            clearEval(evalres.start, evalres.end);


            var coderes = {markedText : cm.markText(CodeMirror.Pos(evalres.start.line, evalres.start.pos),
                         CodeMirror.Pos(evalres.end.line,
                          evalres.end.pos),
                         {css: ("background-color: hsl(" + Math.floor(Math.random()*255) + ", 90%, 95%) "), 
                         clearWhenEmpty:true}),
             lineWidget : cm.addLineWidget(evalres.end.line, createYoloElement(evalres.eval))};

            coderes.markedText.coderes = coderes;

            allCoderes.push(coderes);



        };

        editor.addKeyMap({"Cmd-Enter" : function(cm) {
            var cursor = cm.getCursor();
            $.post("/eval", {text:cm.getValue(), line : cursor.line, pos : cursor.ch}).done(function(data) {
                createEvalResult(cm, jQuery.parseJSON(data));
            });


        }});
    </script>
  </article>
